import{_ as he,r as v,c as F,z as ge,o as ye,K as ke,j as i,h as n,i as a,w as o,f as d,F as B,y as U,k as g,t as _,x as Ce,M as K,g as r,l as b,v as we,n as q,p as z,P as be,e as $,a as Me,Q as xe,N as Pe,A as j,E as M}from"./index-CNVEcACA.js";import{l as Ve}from"./index-BLRFddlS.js";import{u as G}from"./index.es-AM15teyr.js";import{_ as Q}from"./request-CwFpdHqZ.js";const Ie={key:0,class:"loading-container"},ze={key:1,class:"consultation-container"},Ee={class:"patient-list-panel"},Te=["onClick"],Ae={class:"patient-info"},Be={class:"patient-name"},Ue={class:"last-message"},je={class:"chat-panel"},He={key:0,class:"chat-header"},Le={class:"chat-info"},Ne={key:0,class:"patient-info-content"},Se={class:"patient-profile"},De={class:"patient-basic-info"},Fe={class:"patient-details-info"},Ke={class:"info-item"},qe={class:"value"},$e={class:"info-item"},Ge={class:"value"},Qe={class:"info-item"},Re={class:"value"},We={class:"info-item"},Je={class:"value"},Oe={class:"dialog-footer"},Xe={key:0,class:"empty-chat"},Ye={key:1},Ze={class:"message-content"},et=["innerHTML"],tt={key:1,class:"message-image"},st={class:"message-time"},at={key:1,class:"input-container"},lt={class:"input-actions"},nt={class:"left-buttons"},ot={key:0,class:"emoji-picker"},rt=["onClick"],ut={__name:"DoctorChat",setup(it){const R=ge,E=Me,T=v(!0),x=v(!1),W=v(["😊","😂","😍","😢","😎","😡","👍","👎","❤️","🎉","🔥","💯","👏","🙌","🙏"]),J=()=>{x.value=!x.value},O=t=>{p.value+=t,x.value=!1},k=v(!1),X=()=>{s.value&&(k.value=!0)},H=()=>{k.value=!1},Y=()=>{k.value=!1,K(()=>{const t=document.querySelector(".input-container textarea");t&&t.focus()})},Z=t=>{if(!t)return"未知";const e=j(t),u=j();return e.isValid()?u.diff(e,"year"):"未知"},ee=t=>{switch(t){case"male":case"M":case 1:return"男";case"female":case"F":case 0:return"女";default:return"未知"}},m=v([]),{runAsync:L}=G(()=>Q.get("/api/chat/user_list"),{manual:!0}),s=v(null),c=v({}),N=F(()=>s.value?c.value[s.value.id]||[]:[]),p=v(""),f=v(null),P=v(null),te=t=>j(t).format("HH:mm"),se=(t,e)=>(e===0||N.value[e-1],!0),ae=t=>{const e=c.value[t]||[];if(!e||e.length===0)return"暂无消息";const u=e[e.length-1];return u.type==="image"?"[图片]":u.content.length>12?u.content.substring(0,12)+"...":u.content},h=F(()=>"doctor_"+R.value),le=()=>{f.value=Ve("ws://localhost:5000"),f.value.on("connect",()=>{}),f.value.on("newMessage",t=>{if(c.value[t.from_user]||(c.value[t.from_user]=[]),c.value[t.from_user].push({...t,read:t.from_user==="patient"+s.value.id?1:0}),A(s.value.id),t.from_user!==h.value){const e=m.value.find(u=>"patient_"+u.id===t.from_user);e&&s.value.id!==e.id&&(e.unreadCount=(e.unreadCount||0)+1)}L().then(e=>{m.value=e.data.data||[]}).catch(e=>{}),C()})},C=()=>{K(()=>{P.value&&(P.value.scrollTop=P.value.scrollHeight)})},S=t=>{s.value=t,t.unreadCount>0&&(t.unreadCount=0),A(t.id),C()},{runAsync:ne}=G((t,e)=>Q.get("/api/chat/message",{params:{from_user:t,to_user:e}}),{manual:!0}),A=async t=>{const u=(await ne("patient_"+t,h.value)).data.data||[];c.value[t]=u,C()},D=()=>{if(!p.value.trim()||!s.value)return;const t={from_user:h.value,from_user_avatar:E.value,to_user:"patient_"+s.value.id,to_user_avatar:s.value.avatar||"/public/vite.svg",content:p.value.trim(),type:"text"};f.value&&f.value.emit("sendMessage",t),c.value[s.value.id]||(c.value[s.value.id]=[]),c.value[s.value.id].push(t),p.value="",C()},oe=t=>{const e=t.type.startsWith("image/"),u=t.size/1024/1024<5;return e?u?!0:(M.error("上传的图片大小不能超过 5MB"),!1):(M.error("只能上传图片格式的文件"),!1)},re=t=>{t.code===1?(ie(t.data.file_url),M.success("图片上传成功")):M.error(t.msg||"图片上传失败")},ue=t=>{M.error("图片上传失败，请重试")},ie=t=>{if(!s.value)return;const e={from_user:h.value,from_user_avatar:E.value,to_user:"patient_"+s.value.id,to_user_avatar:s.value.avatar_url,content:t,type:"image"};f.value&&f.value.emit("sendMessage",e),c.value[s.value.id]||(c.value[s.value.id]=[]),c.value[s.value.id].push(e),C()};return ye(async()=>{try{const t=await L();m.value=t.data.data||[];for(const e of m.value)await A(e.id);le(),m.value.length>0&&S(m.value[0]),T.value=!1}catch{T.value=!1}}),ke(()=>{f.value&&f.value.disconnect()}),(t,e)=>{const u=d("el-icon"),V=d("el-avatar"),ce=d("el-badge"),de=d("el-divider"),I=d("el-col"),ve=d("el-row"),w=d("el-button"),_e=d("el-dialog"),fe=d("el-image"),me=d("el-input"),pe=d("el-upload");return T.value?(r(),i("div",Ie,[n(u,{class:"loading-icon",size:40},{default:o(()=>[n(b(we))]),_:1}),e[2]||(e[2]=a("p",null,"正在加载...",-1))])):(r(),i("div",ze,[a("div",Ee,[e[3]||(e[3]=a("div",{class:"patient-list-header"},[a("h3",null,"患者列表")],-1)),(r(!0),i(B,null,U(m.value,l=>{var y;return r(),i("div",{key:l.id,class:q(["patient-item",{active:((y=s.value)==null?void 0:y.id)===l.id}]),onClick:ct=>S(l)},[n(ce,{value:l.unreadCount,max:99,hidden:l.unreadCount===0},{default:o(()=>[n(V,{size:48,src:l.avatar_url},null,8,["src"])]),_:2},1032,["value","hidden"]),a("div",Ae,[a("div",Be,_(l.name),1),a("div",Ue,_(ae(l.id)),1)])],10,Te)}),128))]),a("div",je,[s.value?(r(),i("div",He,[n(V,{size:40,src:s.value.avatar_url,onClick:X,class:"patient-avatar-clickable"},null,8,["src"]),a("div",Le,[a("h3",null,_(s.value.name)+" 患者",1)])])):g("",!0),n(_e,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=l=>k.value=l),title:"患者信息",width:"500px","before-close":H},{footer:o(()=>[a("span",Oe,[n(w,{onClick:H},{default:o(()=>e[8]||(e[8]=[z("关闭")])),_:1,__:[8]}),n(w,{type:"primary",onClick:Y},{default:o(()=>e[9]||(e[9]=[z("继续问诊")])),_:1,__:[9]})])]),default:o(()=>[s.value?(r(),i("div",Ne,[a("div",Se,[n(V,{size:80,src:s.value.avatar_url},null,8,["src"]),a("div",De,[a("h2",null,_(s.value.name),1)])]),n(de),a("div",Fe,[n(ve,{gutter:20},{default:o(()=>[n(I,{span:12},{default:o(()=>[a("div",Ke,[e[4]||(e[4]=a("span",{class:"label"},"性别：",-1)),a("span",qe,_(ee(s.value.gender)),1)])]),_:1}),n(I,{span:12},{default:o(()=>[a("div",$e,[e[5]||(e[5]=a("span",{class:"label"},"年龄：",-1)),a("span",Ge,_(Z(s.value.birth_date))+"岁",1)])]),_:1}),n(I,{span:24},{default:o(()=>[a("div",Qe,[e[6]||(e[6]=a("span",{class:"label"},"地址：",-1)),a("span",Re,_(s.value.address||"暂无地址信息"),1)])]),_:1}),n(I,{span:24},{default:o(()=>[a("div",We,[e[7]||(e[7]=a("span",{class:"label"},"病史：",-1)),a("span",Je,_(s.value.medical_history||"暂无病史记录"),1)])]),_:1})]),_:1})])])):g("",!0)]),_:1},8,["modelValue"]),a("div",{ref_key:"messagesContainer",ref:P,class:"messages-container"},[s.value?(r(),i("div",Ye,[(r(!0),i(B,null,U(N.value,(l,y)=>(r(),i("div",{key:y,class:q(["message-item",l.from_user===h.value?"sent":"received"])},[se(l,y)?(r(),$(V,{key:0,size:36,src:l.from_user===h.value?b(E):s.value.avatar_url,class:"message-avatar"},null,8,["src"])):g("",!0),a("div",Ze,[l.type==="text"?(r(),i("div",{key:0,class:"message-text",innerHTML:l.content},null,8,et)):l.type==="image"?(r(),i("div",tt,[n(fe,{src:l.content,"preview-src-list":[l.content],fit:"cover",style:{"max-width":"200px","max-height":"200px","border-radius":"8px"}},null,8,["src","preview-src-list"])])):g("",!0),a("div",st,_(te(l.time)),1),l.from_user!==h.value&&!l.read?(r(),$(u,{key:2,class:"read-status"},{default:o(()=>[n(b(xe))]),_:1})):g("",!0)])],2))),128))])):(r(),i("div",Xe,[n(u,null,{default:o(()=>[n(b(be))]),_:1}),e[10]||(e[10]=a("p",null,"请选择患者开始问诊",-1))]))],512),s.value?(r(),i("div",at,[n(me,{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=l=>p.value=l),placeholder:"输入您的问题...",type:"textarea",rows:2,resize:"none",onKeyup:Ce(D,["enter"])},null,8,["modelValue"]),a("div",lt,[a("div",nt,[n(pe,{class:"image-uploader",action:"/api/upload/picture","show-file-list":!1,"before-upload":oe,"on-success":re,"on-error":ue},{default:o(()=>[n(w,null,{default:o(()=>[n(u,null,{default:o(()=>[n(b(Pe))]),_:1})]),_:1})]),_:1}),n(w,{onClick:J},{default:o(()=>e[11]||(e[11]=[z(" 😊 ")])),_:1,__:[11]})]),n(w,{type:"primary",onClick:D,disabled:!p.value.trim()},{default:o(()=>e[12]||(e[12]=[z(" 发送 ")])),_:1,__:[12]},8,["disabled"]),x.value?(r(),i("div",ot,[(r(!0),i(B,null,U(W.value,l=>(r(),i("span",{key:l,class:"emoji-item",onClick:y=>O(l)},_(l),9,rt))),128))])):g("",!0)])])):g("",!0)])]))}}},mt=he(ut,[["__scopeId","data-v-981ce33d"]]);export{mt as default};
